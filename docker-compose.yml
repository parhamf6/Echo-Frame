services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: echoframe-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: echoframe_user
      POSTGRES_PASSWORD: echoframe_password_change_this
      POSTGRES_DB: echoframe_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - echoframe-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U echoframe_user -d echoframe_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: echoframe-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - echoframe-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # LiveKit Server (Audio + Data Channel Only)
  # livekit:
  #   image: livekit/livekit-server:latest
  #   container_name: echoframe-livekit
  #   restart: unless-stopped
  #   ports:
  #     - "7880:7880"      # WebSocket/HTTP
  #     - "7881:7881"      # HTTP API
  #     - "7882:7882/udp"  # TURN/STUN
  #     - "50000-50100:50000-50100/udp"  # RTC - Reduced range for audio only
  #   volumes:
  #     - ./livekit.yaml:/etc/livekit.yaml:ro
  #   networks:
  #     - echoframe-network
  #   command: --config /etc/livekit.yaml
  #   healthcheck:
  #     test: ["CMD", "wget", "--spider", "-q", "http://localhost:7880"]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s
  #   depends_on:
  #     - redis
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1.0'      # Reduced from 2.0 (audio is much lighter than video)
  #         memory: 512M     # Reduced from 1G (audio-only needs ~5MB per user)
  #       reservations:
  #         cpus: '0.5'
  #         memory: 256M
  #   mem_swappiness: 0
  #   ulimits:
  #     nofile:
  #       soft: 65536
  #       hard: 65536

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  echoframe-network:
    driver: bridge